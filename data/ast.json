{ "sp_process_order":
  {
  "procedure": "sp_process_order",
  "params": [
    "@customer_id INT",
    "@order_date DATETIME",
    "@item_id INT",
    "@quantity INT",
    "@order_status VARCHAR(20) OUTPUT"
  ],
  "statements": [
    "declare @order_id int",
    "declare @available_qty int",
    "begin transaction",
    "select @available_qty = quantity from inventory where item_id = @item_id",
    "if @available_qty < @quantity begin",
    "set @order_status = 'FAILED - OUT OF STOCK'",
    "rollback transaction",
    "return",
    "end",
    "insert into orders (customer_id, order_date) values (@customer_id, @order_date)",
    "select @order_id = @@identity",
    "insert into order_items (order_id, item_id, quantity) values (@order_id, @item_id, @quantity)",
    "update inventory set quantity = quantity - @quantity where item_id = @item_id",
    "exec sp_log_order @order_id, @customer_id, @order_date",
    "commit transaction",
    "set @order_status = 'SUCCESS'"
  ],
  "variables": [
    "@order_id",
    "@available_qty"
  ],
  "cursors": []
}
}
