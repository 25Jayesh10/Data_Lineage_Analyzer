[
  {
    "proc_name": "AcmeERP.usp_CalculateFifoCost",
    "params": [
      {
        "name": "@ProductID",
        "type": "INT",
        "mode": "IN"
      },
      {
        "name": "@QuantityRequested",
        "type": "INT",
        "mode": "IN"
      }
    ],
    "return_type": "VOID",
    "variables": [],
    "statements": [
      {
        "type": "WITH_CTE",
        "cte_list": [
          {
            "name": "CTE_FIFO",
            "query": {
              "type": "SELECT",
              "columns": [
                "MovementID",
                "ProductID",
                "Quantity",
                "UnitCost",
                "SUM(Quantity) OVER (PARTITION BY ProductID ORDER BY MovementDate ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS RunningTotal"
              ],
              "from": "AcmeERP.StockMovements",
              "where": {
                "type": "RAW_EXPRESSION",
                "expression": "ProductID = @ProductID AND Direction = 'IN'"
              }
            }
          }
        ],
        "main_query": {
          "type": "SELECT",
          "columns": [
            "AVG(UnitCost) AS FifoCostEstimate"
          ],
          "from": "CTE_FIFO",
          "where": {
            "type": "RAW_EXPRESSION",
            "expression": "RunningTotal <= @QuantityRequested"
          }
        }
      }
    ]
  },
  {
    "proc_name": "AcmeERP.usp_ProcessFullPayrollCycle",
    "params": [
      { "name": "@PayPeriodStart", "type": "DATE", "mode": "IN" },
      { "name": "@PayPeriodEnd", "type": "DATE", "mode": "IN" }
    ],
    "return_type": "VOID",
    "variables": [
      { "name": "@EmployeeID", "type": "INT" },
      { "name": "@BaseSalary", "type": "DECIMAL" },
      { "name": "@Bonus", "type": "DECIMAL" },
      { "name": "@GrossSalary", "type": "DECIMAL" },
      { "name": "@Tax", "type": "DECIMAL" },
      { "name": "@NetSalary", "type": "DECIMAL" },
      { "name": "@Currency", "type": "CHAR" },
      { "name": "@ConvertedSalary", "type": "DECIMAL" },
      { "name": "@ExchangeRate", "type": "DECIMAL" },
      { "name": "@CurrentDate", "type": "DATE", "default": { "type": "RAW_EXPRESSION", "expression": "GETDATE()" } },
      { "name": "@ErrorMsg", "type": "NVARCHAR" },
      { "name": "@ErrorSeverity", "type": "INT" },
      { "name": "@ErrorState", "type": "INT" }
    ],
    "statements": [
      { "type": "SET", "name": "NOCOUNT", "value": "ON" },
      {
        "type": "TRY",
        "body": [
          { "type": "BEGIN_TRANSACTION" },
          {
            "type": "IF",
            "condition": { "type": "RAW_EXPRESSION", "expression": "OBJECT_ID('tempdb..#PayrollCalc') IS NOT NULL" },
            "then": [ { "type": "DROP_TABLE", "table": "#PayrollCalc" } ]
          },
          { "type": "DECLARE_TEMP_TABLE", "table": "#PayrollCalc" },
          {
            "type": "INSERT",
            "table": "#PayrollCalc",
            "columns": ["EmployeeID", "BaseSalary", "Bonus", "GrossSalary", "Tax", "NetSalary", "Currency"],
            "select_statement": {
              "type": "SELECT",
              "columns": [
                "e.EmployeeID",
                "e.BaseSalary",
                "Bonus",
                "GrossSalary",
                "Tax",
                "NetSalary",
                "ISNULL(e.Currency, 'USD') AS Currency"
              ],
              "from": "AcmeERP.Employees"
            }
          },
          {
            "type": "DECLARE_CURSOR",
            "cursor_name": "PayrollCursor",
            "select_statement": {
              "type": "SELECT",
              "columns": ["EmployeeID", "GrossSalary", "Currency"],
              "from": "#PayrollCalc"
            }
          },
          { "type": "OPEN_CURSOR", "cursor_name": "PayrollCursor" },
          { "type": "FETCH_CURSOR", "cursor_name": "PayrollCursor", "fetch_into": ["@EmployeeID", "@GrossSalary", "@Currency"] },
          {
            "type": "WHILE",
            "condition": { "type": "RAW_EXPRESSION", "expression": "@@FETCH_STATUS = 0" },
            "body": [
              {
                "type": "IF",
                "condition": { "type": "RAW_EXPRESSION", "expression": "@Currency <> 'USD'" },
                "then": [
                  {
                    "type": "SELECT_INTO",
                    "query": "SELECT TOP 1 RateToBase FROM AcmeERP.ExchangeRates WHERE CurrencyCode = @Currency AND RateDate <= @CurrentDate ORDER BY RateDate DESC",
                    "into_vars": ["@ExchangeRate"]
                  },
                  {
                    "type": "IF",
                    "condition": { "type": "RAW_EXPRESSION", "expression": "@ExchangeRate IS NULL" },
                    "then": [
                      { "type": "SET", "name": "@ExchangeRate", "value": 1 }
                    ]
                  },
                  { "type": "SET", "name": "@ConvertedSalary", "value": { "type": "RAW_EXPRESSION", "expression": "@GrossSalary * @ExchangeRate" } }
                ],
                "else": [
                  { "type": "SET", "name": "@ConvertedSalary", "value": "@GrossSalary" }
                ]
              },
              {
                "type": "UPDATE",
                "table": "#PayrollCalc",
                "set": { "ConvertedSalary": "@ConvertedSalary" },
                "where": { "type": "RAW_EXPRESSION", "expression": "EmployeeID = @EmployeeID" }
              },
              { "type": "FETCH_CURSOR", "cursor_name": "PayrollCursor", "fetch_into": ["@EmployeeID", "@GrossSalary", "@Currency"] }
            ]
          },
          { "type": "CLOSE_CURSOR", "cursor_name": "PayrollCursor" },
          { "type": "DEALLOCATE_CURSOR", "cursor_name": "PayrollCursor" },
          {
            "type": "INSERT",
            "table": "AcmeERP.PayrollLogs",
            "columns": ["EmployeeID", "PayPeriodStart", "PayPeriodEnd", "GrossSalary", "TaxDeducted"],
            "select_statement": {
              "type": "SELECT",
              "columns": ["EmployeeID", "@PayPeriodStart", "@PayPeriodEnd", "ConvertedSalary", "Tax"],
              "from": "#PayrollCalc"
            }
          },
          { "type": "COMMIT" }
        ],
        "catch": [
          {
            "exception": "CATCH_ALL",
            "body": [
              {
                "type": "IF",
                "condition": { "type": "RAW_EXPRESSION", "expression": "@@TRANCOUNT > 0" },
                "then": [ { "type": "ROLLBACK" } ]
              },
              {
                "type": "SELECT_INTO",
                "query": "SELECT ERROR_MESSAGE(), ERROR_SEVERITY(), ERROR_STATE()",
                "into_vars": ["@ErrorMsg", "@ErrorSeverity", "@ErrorState"]
              },
              {
                "type": "RAISE",
                "message": { "type": "RAW_EXPRESSION", "expression": "@ErrorMsg" }
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "proc_name": "AcmeERP.usp_ConvertToBase",
    "params": [
      {
        "name": "@CurrencyCode",
        "type": "CHAR",
        "mode": "IN"
      },
      {
        "name": "@Amount",
        "type": "DECIMAL",
        "mode": "IN"
      },
      {
        "name": "@ConversionDate",
        "type": "DATE",
        "mode": "IN"
      }
    ],
    "return_type": "VOID",
    "variables": [
      {
        "name": "@Rate",
        "type": "DECIMAL"
      }
    ],
    "statements": [
      {
        "type": "SELECT",
        "columns": [
          "RateToBase"
        ],
        "from": "AcmeERP.ExchangeRates",
        "where": {
          "op": "AND",
          "left": {
            "op": "=",
            "left": "CurrencyCode",
            "right": "@CurrencyCode"
          },
          "right": {
            "op": "=",
            "left": "RateDate",
            "right": "@ConversionDate"
          }
        }
      },
      {
        "type": "SET",
        "name": "@Rate",
        "value": "RateToBase"
      },
      {
        "type": "IF",
        "condition": {
          "op": "IS_NULL",
          "left": "@Rate"
        },
        "then": [
          {
            "type": "SELECT",
            "columns": [
              "TOP 1 RateToBase"
            ],
            "from": "AcmeERP.ExchangeRates",
            "where": {
              "op": "AND",
              "left": {
                "op": "=",
                "left": "CurrencyCode",
                "right": "@CurrencyCode"
              },
              "right": {
                "op": "<",
                "left": "RateDate",
                "right": "@ConversionDate"
              }
            },
            "order_by": [
              "RateDate DESC"
            ]
          },
          {
            "type": "SET",
            "name": "@Rate",
            "value": "RateToBase"
          }
        ]
      },
      {
        "type": "IF",
        "condition": {
          "op": "IS_NULL",
          "left": "@Rate"
        },
        "then": [
          {
            "type": "SELECT",
            "columns": [
              "AVG(RateToBase)"
            ],
            "from": "AcmeERP.ExchangeRates",
            "where": {
              "op": "BETWEEN",
              "left": "RateDate",
              "right": {
                "op": "AND",
                "left": {
                  "type": "RAW_EXPRESSION",
                  "expression": "DATEADD(DAY, -7, @ConversionDate)"
                },
                "right": "@ConversionDate"
              }
            }
          },
          {
            "type": "SET",
            "name": "@Rate",
            "value": "AVG(RateToBase)"
          }
        ]
      },
      {
        "type": "IF",
        "condition": {
          "op": "IS_NULL",
          "left": "@Rate"
        },
        "then": [
          {
            "type": "SET",
            "name": "@Rate",
            "value": 1
          }
        ]
      },
      {
        "type": "SELECT",
        "columns": [
          {
            "type": "RAW_EXPRESSION",
            "expression": "@Amount * @Rate AS ConvertedAmount"
          }
        ],
        "from": ""
      }
    ]
  },
  {
    "proc_name": "sp_sum_client_orders",
    "params": [
      {
        "name": "@client_id",
        "type": "INTEGER",
        "mode": "IN"
      },
      {
        "name": "@from_date",
        "type": "DATE",
        "mode": "IN"
      },
      {
        "name": "@to_date",
        "type": "DATE",
        "mode": "IN"
      }
    ],
    "return_type": "NUMERIC",
    "variables": [
      {
        "name": "@grand_total",
        "type": "NUMERIC",
        "default": null
      },
      {
        "name": "@order_total",
        "type": "NUMERIC",
        "default": null
      }
    ],
    "statements": [
      {
        "type": "DECLARE_CURSOR",
        "cursor_name": "cur_orders",
        "select_statement": {
          "type": "SELECT",
          "columns": ["total_price"],
          "from": "client_orders",
          "where": {
            "op": "AND",
            "left": {
              "op": "AND",
              "left": {
                "op": "=",
                "left": "client_id",
                "right": "@client_id"
              },
              "right": {
                "op": "BETWEEN",
                "left": "order_date",
                "right": {
                  "type": "RAW_EXPRESSION",
                  "expression": "@from_date AND @to_date"
                }
              }
            },
            "right": null
          }
        }
      },
      {
        "type": "SET",
        "name": "@grand_total",
        "value": 0.00
      },
      {
        "type": "OPEN_CURSOR",
        "cursor_name": "cur_orders"
      },
      {
        "type": "FETCH_CURSOR",
        "cursor_name": "cur_orders",
        "fetch_into": ["@order_total"]
      },
      {
        "type": "WHILE",
        "condition": {
          "op": "=",
          "left": "@@sqlstatus",
          "right": 0
        },
        "body": [
          {
            "type": "IF",
            "condition": {
              "op": ">",
              "left": "@order_total",
              "right": 750
            },
            "then": [
              {
                "type": "SET",
                "name": "@grand_total",
                "value": {
                  "op": "+",
                  "left": "@grand_total",
                  "right": {
                    "op": "*",
                    "left": "@order_total",
                    "right": 0.95
                  }
                }
              }
            ],
            "else": [
              {
                "type": "SET",
                "name": "@grand_total",
                "value": {
                  "op": "+",
                  "left": "@grand_total",
                  "right": "@order_total"
                }
              }
            ]
          },
          {
            "type": "FETCH_CURSOR",
            "cursor_name": "cur_orders",
            "fetch_into": ["@order_total"]
          }
        ]
      },
      {
        "type": "CLOSE_CURSOR",
        "cursor_name": "cur_orders"
      },
      {
        "type": "DEALLOCATE_CURSOR",
        "cursor_name": "cur_orders"
      },
      {
        "type": "IF",
        "condition": {
          "op": ">",
          "left": "@grand_total",
          "right": 10000
        },
        "then": [
          {
            "type": "RAISE",
            "message": "High-value threshold exceeded for client"
          }
        ]
      },
      {
        "type": "RETURN",
        "expression": "@grand_total"
      }
    ]
  },
  {
    "proc_name": "log_hr_employees",
    "params": [],
    "return_type": "VOID",
    "variables": [
      {
        "name": "@emp_id",
        "type": "INT"
      },
      {
        "name": "@emp_name",
        "type": "VARCHAR"
      }
    ],
    "statements": [
      {
        "type": "DECLARE_CURSOR",
        "cursor_name": "emp_cursor",
        "select_statement": {
          "type": "SELECT",
          "columns": ["emp_id", "emp_name"],
          "from": "employees",
          "where": {
            "op": "=",
            "left": "department",
            "right": "'HR'"
          }
        }
      },
      {
        "type": "OPEN_CURSOR",
        "cursor_name": "emp_cursor"
      },
      {
        "type": "FETCH_CURSOR",
        "cursor_name": "emp_cursor",
        "fetch_into": ["@emp_id", "@emp_name"]
      },
      {
        "type": "WHILE",
        "condition": {
          "op": "=",
          "left": "@@sqlstatus",
          "right": 0
        },
        "body": [
          {
            "type": "INSERT",
            "table": "employee_log",
            "columns": ["emp_id", "emp_name", "log_time"],
            "values": [
              "@emp_id",
              "@emp_name",
              {
                "type": "RAW_EXPRESSION",
                "expression": "GETDATE()"
              }
            ]
          },
          {
            "type": "FETCH_CURSOR",
            "cursor_name": "emp_cursor",
            "fetch_into": ["@emp_id", "@emp_name"]
          }
        ]
      },
      {
        "type": "CLOSE_CURSOR",
        "cursor_name": "emp_cursor"
      },
      {
        "type": "DEALLOCATE_CURSOR",
        "cursor_name": "emp_cursor"
      }
    ]
  },
  {
    "proc_name": "test1",
    "params": [
      {
        "name": "@client_id",
        "type": "INT",
        "mode": "IN"
      },
      {
        "name": "@from_date",
        "type": "DATE",
        "mode": "IN"
      },
      {
        "name": "@to_date",
        "type": "DATE",
        "mode": "IN"
      }
    ],
    "return_type": "NUMERIC",
    "variables": [
      {
        "name": "@grand_total",
        "type": "NUMERIC",
        "default": 0.00
      },
      {
        "name": "@order_total",
        "type": "NUMERIC"
      }
    ],
    "statements": [
      {
        "type": "SET",
        "name": "@grand_total",
        "value": 0.00
      },
      {
        "type": "DECLARE_CURSOR",
        "cursor_name": "cur_orders",
        "select_statement": {
          "type": "SELECT",
          "columns": ["total_price"],
          "from": "client_orders",
          "where": {
            "op": "AND",
            "left": {
              "op": "=",
              "left": "client_id",
              "right": "@client_id"
            },
            "right": {
              "op": "BETWEEN",
              "left": "order_date",
              "right": {
                "type": "RAW_EXPRESSION",
                "expression": "@from_date AND @to_date"
              }
            }
          }
        }
      },
      {
        "type": "OPEN_CURSOR",
        "cursor_name": "cur_orders"
      },
      {
        "type": "FETCH_CURSOR",
        "cursor_name": "cur_orders",
        "fetch_into": ["@order_total"]
      },
      {
        "type": "WHILE",
        "condition": {
          "op": "=",
          "left": "@@FETCH_STATUS",
          "right": 0
        },
        "body": [
          {
            "type": "IF",
            "condition": {
              "op": ">",
              "left": "@order_total",
              "right": 750
            },
            "then": [
              {
                "type": "SET",
                "name": "@grand_total",
                "value": {
                  "op": "+",
                  "left": "@grand_total",
                  "right": {
                    "op": "*",
                    "left": "@order_total",
                    "right": 0.95
                  }
                }
              }
            ],
            "else": [
              {
                "type": "SET",
                "name": "@grand_total",
                "value": {
                  "op": "+",
                  "left": "@grand_total",
                  "right": "@order_total"
                }
              }
            ]
          },
          {
            "type": "FETCH_CURSOR",
            "cursor_name": "cur_orders",
            "fetch_into": ["@order_total"]
          }
        ]
      },
      {
        "type": "CLOSE_CURSOR",
        "cursor_name": "cur_orders"
      },
      {
        "type": "DEALLOCATE_CURSOR",
        "cursor_name": "cur_orders"
      },
      {
        "type": "IF",
        "condition": {
          "op": ">",
          "left": "@grand_total",
          "right": 10000
        },
        "then": [
          {
            "type": "RAISE",
            "message": "High-value threshold exceeded for client",
            "level": "ERROR"
          }
        ]
      },
      {
        "type": "RETURN",
        "expression": "@grand_total"
      }
    ]
  },
  {
    "proc_name": "sp_sum_client_orders",
    "params": [
      {
        "name": "@client_id",
        "type": "INTEGER",
        "mode": "IN"
      },
      {
        "name": "@from_date",
        "type": "DATE",
        "mode": "IN"
      },
      {
        "name": "@to_date",
        "type": "DATE",
        "mode": "IN"
      }
    ],
    "return_type": "NUMERIC",
    "variables": [
      {
        "name": "@grand_total",
        "type": "NUMERIC",
        "default": null
      },
      {
        "name": "@order_total",
        "type": "NUMERIC",
        "default": null
      }
    ],
    "statements": [
      {
        "type": "DECLARE_CURSOR",
        "cursor_name": "cur_orders",
        "select_statement": {
          "type": "SELECT",
          "columns": ["total_price"],
          "from": "client_orders",
          "where": {
            "type": "RAW_EXPRESSION",
            "expression": "client_id = @client_id AND order_date BETWEEN @from_date AND @to_date"
          }
        }
      },
      {
        "type": "SET",
        "name": "@grand_total",
        "value": 0.00
      },
      {
        "type": "OPEN_CURSOR",
        "cursor_name": "cur_orders"
      },
      {
        "type": "FETCH_CURSOR",
        "cursor_name": "cur_orders",
        "fetch_into": ["@order_total"]
      },
      {
        "type": "WHILE",
        "condition": {
          "type": "RAW_EXPRESSION",
          "expression": "@@sqlstatus = 0"
        },
        "body": [
          {
            "type": "IF",
            "condition": {
              "op": ">",
              "left": "@order_total",
              "right": 750
            },
            "then": [
              {
                "type": "SET",
                "name": "@grand_total",
                "value": {
                  "op": "+",
                  "left": "@grand_total",
                  "right": {
                    "op": "*",
                    "left": "@order_total",
                    "right": 0.95
                  }
                }
              }
            ],
            "else": [
              {
                "type": "SET",
                "name": "@grand_total",
                "value": {
                  "op": "+",
                  "left": "@grand_total",
                  "right": "@order_total"
                }
              }
            ]
          },
          {
            "type": "FETCH_CURSOR",
            "cursor_name": "cur_orders",
            "fetch_into": ["@order_total"]
          }
        ]
      },
      {
        "type": "CLOSE_CURSOR",
        "cursor_name": "cur_orders"
      },
      {
        "type": "DEALLOCATE_CURSOR",
        "cursor_name": "cur_orders"
      },
      {
        "type": "IF",
        "condition": {
          "op": ">",
          "left": "@grand_total",
          "right": 10000
        },
        "then": [
          {
            "type": "RAISE",
            "message": "High-value threshold exceeded for client",
            "level": "ERROR"
          }
        ]
      },
      {
        "type": "RETURN",
        "expression": "@grand_total"
      }
    ]
  },
  {
    "proc_name": "sp_update_inventory",
    "params": [],
    "return_type": "VOID",
    "variables": [
      {
        "name": "@product_id",
        "type": "INT"
      },
      {
        "name": "@quantity",
        "type": "INT"
      }
    ],
    "statements": [
      {
        "type": "DECLARE_CURSOR",
        "cursor_name": "inventory_cursor",
        "select_statement": {
          "type": "SELECT",
          "columns": ["product_id"],
          "from": "products",
          "where": {
            "op": "=",
            "left": "discontinued",
            "right": 0
          }
        }
      },
      {
        "type": "OPEN_CURSOR",
        "cursor_name": "inventory_cursor"
      },
      {
        "type": "FETCH_CURSOR",
        "cursor_name": "inventory_cursor",
        "fetch_into": ["@product_id"]
      },
      {
        "type": "WHILE",
        "condition": {
          "op": "=",
          "left": "@@FETCH_STATUS",
          "right": 0
        },
        "body": [
          {
            "type": "SELECT_INTO",
            "query": "SELECT SUM(quantity) FROM inventory WHERE product_id = @product_id",
            "into_vars": ["@quantity"]
          },
          {
            "type": "IF",
            "condition": {
              "op": "<",
              "left": "@quantity",
              "right": 10
            },
            "then": [
              {
                "type": "UPDATE",
                "table": "products",
                "set": {
                  "restock": 1
                },
                "where": {
                  "op": "=",
                  "left": "product_id",
                  "right": "@product_id"
                }
              }
            ]
          },
          {
            "type": "FETCH_CURSOR",
            "cursor_name": "inventory_cursor",
            "fetch_into": ["@product_id"]
          }
        ]
      },
      {
        "type": "CLOSE_CURSOR",
        "cursor_name": "inventory_cursor"
      },
      {
        "type": "DEALLOCATE_CURSOR",
        "cursor_name": "inventory_cursor"
      }
    ]
  }
]
