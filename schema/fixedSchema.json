{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Enterprise Stored Procedure AST Schema",
  "description": "Enterprise-grade schema for stored procedure AST with full edge case handling.",
  "type": "array",
  "items": {
    "type": "object",
    "required": [
      "proc_name",
      "params",
      "return_type",
      "variables",
      "statements"
    ],
    "properties": {
      "proc_name": {
        "type": "string",
        "minLength": 1
      },
      "params": {
        "type": "array",
        "items": {
          "type": "object",
          "required": [
            "name",
            "type",
            "mode"
          ],
          "properties": {
            "name": {
              "type": "string",
              "minLength": 1
            },
            "type": {
              "type": "string",
              "enum": [
                "INT",
                "INTEGER",
                "BIGINT",
                "SMALLINT",
                "TINYINT",
                "VARCHAR",
                "CHAR",
                "NVARCHAR",
                "TEXT",
                "BOOLEAN",
                "DATE",
                "TIMESTAMP",
                "DATETIME",
                "TIME",
                "FLOAT",
                "NUMERIC",
                "DECIMAL"
              ]
            },
            "mode": {
              "type": "string",
              "enum": [
                "IN",
                "OUT",
                "INOUT"
              ]
            },
            "default": {
              "type": [
                "string",
                "number",
                "boolean",
                "null"
              ]
            }
          },
          "additionalProperties": false
        }
      },
      "return_type": {
        "type": "string",
        "enum": [
          "VOID",
          "INT",
          "INTEGER",
          "BIGINT",
          "SMALLINT",
          "TINYINT",
          "VARCHAR",
          "CHAR",
          "NVARCHAR",
          "TEXT",
          "BOOLEAN",
          "DATE",
          "TIMESTAMP",
          "DATETIME",
          "TIME",
          "FLOAT",
          "NUMERIC",
          "DECIMAL"
        ]
      },
      "variables": {
        "type": "array",
        "items": {
          "type": "object",
          "required": [
            "name",
            "type"
          ],
          "properties": {
            "name": {
              "type": "string",
              "minLength": 1
            },
            "type": {
              "type": "string",
              "enum": [
                "INT",
                "INTEGER",
                "BIGINT",
                "SMALLINT",
                "TINYINT",
                "VARCHAR",
                "CHAR",
                "NVARCHAR",
                "TEXT",
                "BOOLEAN",
                "DATE",
                "TIMESTAMP",
                "DATETIME",
                "TIME",
                "FLOAT",
                "NUMERIC",
                "DECIMAL"
              ]
            },
            "default": {
              "type": [
                "string",
                "number",
                "boolean",
                "null"
              ]
            }
          },
          "additionalProperties": false
        }
      },
      "statements": {
        "type": "array",
        "maxItems": 500,
        "items": {
          "$ref": "#/definitions/statement"
        }
      }
    },
    "additionalProperties": false
  },
  "definitions": {
    "expression": {
      "oneOf": [
        {
          "type": "string"
        },
        {
          "type": "object",
          "required": [
            "op",
            "left",
            "right"
          ],
          "properties": {
            "op": {
              "type": "string"
            },
            "left": {
              "$ref": "#/definitions/expression"
            },
            "right": {
              "$ref": "#/definitions/expression"
            }
          }
        },
        {
          "type": "object",
          "required": [
            "type",
            "expression"
          ],
          "properties": {
            "type": {
              "const": "RAW_EXPRESSION"
            },
            "expression": {
              "type": "string"
            }
          },
          "additionalProperties": false
        }
      ]
    },
    "statement": {
      "type": "object",
      "required": [
        "type"
      ],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "SET",
            "UPDATE",
            "INSERT",
            "DELETE",
            "SELECT",
            "SELECT_INTO",
            "WITH_CTE",
            "DROP_TABLE",
            "DECLARE_CURSOR",
            "OPEN_CURSOR",
            "FETCH_CURSOR",
            "CLOSE_CURSOR",
            "DEALLOCATE_CURSOR",
            "RETURN",
            "IF",
            "WHILE",
            "FOR_CURSOR_LOOP",
            "RAISE",
            "TRY",
            "CATCH",
            "EXCEPTION_HANDLER",
            "EXECUTE_PROCEDURE",
            "LOG_MESSAGE",
            "RAW_SQL",
            "BEGIN_TRANSACTION",
            "COMMIT",
            "ROLLBACK",
            "DECLARE_TEMP_TABLE",
            "EXECUTE_USING",
            "CASE",
            "DECLARE",
            "DROP_PROCEDURE_IF_EXISTS",
            "DROP_PROCEDURE"
          ]
        },
        "name": {
          "type": "string"
        },
        "value": {
          "$ref": "#/definitions/expression"
        },
        "expression": {
          "$ref": "#/definitions/expression"
        },
        "message": {
          "type": "string"
        },
        "level": {
          "type": "string",
          "enum": [
            "NOTICE",
            "WARNING",
            "ERROR"
          ]
        },
        "condition": {
          "$ref": "#/definitions/expression"
        },
        "exception": {
          "type": "string"
        },
        "query": {
          "type": "string"
        },
        "select_statement": {
          "$ref": "#/definitions/statement"
        },
        "table": {
          "type": "string"
        },
        "set": {
          "type": "object",
          "patternProperties": {
            "^.*$": {
              "$ref": "#/definitions/expression"
            }
          },
          "additionalProperties": false
        },
        "where": {
          "$ref": "#/definitions/expression"
        },
        "columns": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "values": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/expression"
          }
        },
        "from": {
          "type": "string"
        },
        "group_by": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "having": {
          "$ref": "#/definitions/expression"
        },
        "order_by": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "cursor_name": {
          "type": "string"
        },
        "into_vars": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "fetch_into": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "procedure": {
          "type": "string"
        },
        "args": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/expression"
          }
        },
        "then": {
          "type": "array",
          "maxItems": 20,
          "items": {
            "$ref": "#/definitions/statement"
          }
        },
        "else": {
          "type": "array",
          "maxItems": 20,
          "items": {
            "$ref": "#/definitions/statement"
          }
        },
        "body": {
          "type": "array",
          "maxItems": 20,
          "items": {
            "$ref": "#/definitions/statement"
          }
        },
        "when_clauses": {
          "type": "array",
          "items": {
            "type": "object",
            "required": [
              "condition",
              "then"
            ],
            "properties": {
              "condition": {
                "$ref": "#/definitions/expression"
              },
              "then": {
                "type": "array",
                "items": {
                  "$ref": "#/definitions/statement"
                }
              }
            }
          }
        },
        "catch": {
          "type": "array",
          "maxItems": 5,
          "items": {
            "type": "object",
            "required": [
              "exception",
              "body"
            ],
            "properties": {
              "exception": {
                "type": "string"
              },
              "body": {
                "type": "array",
                "maxItems": 20,
                "items": {
                  "$ref": "#/definitions/statement"
                }
              }
            },
            "additionalProperties": false
          }
        },
        "cte_list": {
          "type": "array",
          "items": {
            "type": "object",
            "required": [
              "name",
              "query"
            ],
            "properties": {
              "name": {
                "type": "string"
              },
              "query": {
                "$ref": "#/definitions/statement"
              }
            },
            "additionalProperties": false
          }
        },
        "main_query": {
          "$ref": "#/definitions/statement"
        },
        "if_exists": {
          "type": "boolean"
        }
      },
      "additionalProperties": false,
      "allOf": [
        {
          "if": {
            "properties": {
              "type": {
                "const": "DROP_TABLE"
              }
            }
          },
          "then": {
            "required": [
              "table"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "RAW_SQL"
              }
            }
          },
          "then": {
            "required": [
              "query"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "DROP_PROCEDURE_IF_EXISTS"
              }
            }
          },
          "then": {
            "required": [
              "procedure"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "SELECT"
              }
            }
          },
          "then": {
            "required": [
              "columns",
              "from"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "INSERT"
              }
            }
          },
          "then": {
            "oneOf": [
              {
                "required": [
                  "table",
                  "values"
                ]
              },
              {
                "required": [
                  "table",
                  "select_statement"
                ]
              }
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "DELETE"
              }
            }
          },
          "then": {
            "required": [
              "table"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "CASE"
              }
            }
          },
          "then": {
            "required": [
              "when_clauses"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "FOR_CURSOR_LOOP"
              }
            }
          },
          "then": {
            "required": [
              "fetch_into",
              "cursor_name",
              "body"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "FETCH_CURSOR"
              }
            }
          },
          "then": {
            "required": [
              "cursor_name",
              "fetch_into"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "DECLARE_CURSOR"
              }
            }
          },
          "then": {
            "required": [
              "cursor_name",
              "select_statement"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "OPEN_CURSOR"
              }
            }
          },
          "then": {
            "required": [
              "cursor_name"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "CLOSE_CURSOR"
              }
            }
          },
          "then": {
            "required": [
              "cursor_name"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "DEALLOCATE_CURSOR"
              }
            }
          },
          "then": {
            "required": [
              "cursor_name"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "UPDATE"
              }
            }
          },
          "then": {
            "required": [
              "table",
              "set"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "SELECT_INTO"
              }
            }
          },
          "then": {
            "required": [
              "query",
              "into_vars"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "RETURN"
              }
            }
          },
          "then": {
            "required": [
              "expression"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "SET"
              }
            }
          },
          "then": {
            "required": [
              "name",
              "value"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "IF"
              }
            }
          },
          "then": {
            "required": [
              "condition",
              "then"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "WHILE"
              }
            }
          },
          "then": {
            "required": [
              "condition",
              "body"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "RAISE"
              }
            }
          },
          "then": {
            "required": [
              "message"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "TRY"
              }
            }
          },
          "then": {
            "required": [
              "body"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "EXCEPTION_HANDLER"
              }
            }
          },
          "then": {
            "required": [
              "exception",
              "body"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "EXECUTE_PROCEDURE"
              }
            }
          },
          "then": {
            "required": [
              "procedure",
              "args"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "WITH_CTE"
              }
            }
          },
          "then": {
            "required": [
              "cte_list",
              "main_query"
            ]
          }
        }
      ]
    }
  }
}